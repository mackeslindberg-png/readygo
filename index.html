<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ready Go</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 540px; margin: 0 auto; }
    h1 { margin: 0 0 12px 0; font-size: 22px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 12px 0; }
    label { display: inline-flex; align-items: center; gap: 8px; }
    select, button { font-size: 16px; padding: 10px 12px; }
    button { width: 100%; height: 52px; border: 0; border-radius: 12px; cursor: pointer; }
    button.start { background: #111; color: #fff; }
    button.stop { background: #b00020; color: #fff; }
    .small { color: #444; font-size: 13px; line-height: 1.4; }
    .status { margin-top: 10px; font-weight: 600; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color:#333; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Ready Go</h1>

    <div class="row">
      <div style="flex:1;">
        <div style="font-weight:600; margin-bottom:6px;">Hastighetsläge</div>
        <select id="mode">
          <option value="fast" selected>Snabb (readygo)</option>
          <option value="mid">Mellan (1,5 sek)</option>
          <option value="slow">Långsam (2,4 sek)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <div style="font-weight:600; margin-bottom:6px;">Startfördröjning (slump)</div>
        <label><input type="radio" name="startWindow" value="2-4" checked> 2–4 sek</label>
        <label style="margin-left:12px;"><input type="radio" name="startWindow" value="3-6"> 3–6 sek</label>
      </div>
    </div>

    <div class="row">
      <label><input type="checkbox" id="repeat"> Repetera (slump 3–6 sek mellan)</label>
    </div>

    <div class="status" id="status">
      Status: redo <span class="pill" id="voiceInfo">röst laddas…</span>
    </div>

    <div class="row" style="margin-top:14px;">
      <button id="startStop" class="start">START</button>
    </div>
  </div>

<script>
(() => {
  const statusEl = document.getElementById('status');
  const voiceInfoEl = document.getElementById('voiceInfo');
  const btn = document.getElementById('startStop');
  const modeEl = document.getElementById('mode');
  const repeatEl = document.getElementById('repeat');

  let running = false;
  let timers = [];
  let session = 0;

  const FAST_RATE = 2.2;

  const TARGET_TOTAL_MS = {
    mid: 1500,
    slow: 2400
  };

  const lastGoMs = { mid: 400, slow: 400 };

  function clearTimers() {
    timers.forEach(t => clearTimeout(t));
    timers = [];
  }

  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function setStatus(text) {
    statusEl.firstChild.textContent = "Status: " + text + " ";
  }

  function getStartWindowMs() {
    const v = document.querySelector('input[name="startWindow"]:checked').value;
    return v === '2-4' ? randInt(2000, 4000) : randInt(3000, 6000);
  }

  function getRepeatGapMs() {
    return randInt(3000, 6000);
  }

  function getVoicesSafe() {
    try { return speechSynthesis.getVoices() || []; }
    catch { return []; }
  }

  function pickVoicePreferFemaleEn() {
    const voices = getVoicesSafe();
    if (!voices.length) return null;

    const femaleHints = ["female", "woman", "jenny", "susan", "emma", "zira", "samantha"];
    const en = voices.filter(v => (v.lang || "").toLowerCase().startsWith("en"));
    const hinted = en.find(v => femaleHints.some(h => (v.name || "").toLowerCase().includes(h)));
    return hinted || en[0] || voices[0];
  }

  let chosenVoice = null;

  function refreshVoices() {
    chosenVoice = pickVoicePreferFemaleEn();
    const voices = getVoicesSafe();
    voiceInfoEl.textContent = chosenVoice
      ? `${chosenVoice.lang} • ${chosenVoice.name}`
      : (voices.length ? "röst ej vald" : "röst laddas…");
  }

  async function ensureVoicesLoaded(maxWaitMs = 2500) {
    const start = performance.now();
    refreshVoices();
    while (performance.now() - start < maxWaitMs) {
      if (getVoicesSafe().length) return true;
      await new Promise(r => setTimeout(r, 150));
      refreshVoices();
    }
    return false;
  }

  speechSynthesis.onvoiceschanged = refreshVoices;
  setTimeout(refreshVoices, 300);

  function speak(text, rate) {
    return new Promise(resolve => {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = rate;
      if (chosenVoice) u.voice = chosenVoice;
      const t0 = performance.now();
      u.onend = () => resolve(performance.now() - t0);
      u.onerror = () => resolve(performance.now() - t0);
      speechSynthesis.speak(u);
    });
  }

  async function speakFast() {
    setStatus("readygo!");
    speechSynthesis.cancel();
    await speak("readygo", FAST_RATE);
  }

  async function speakTimed(mode) {
    const target = TARGET_TOTAL_MS[mode];
    speechSynthesis.cancel();

    setStatus("Ready...");
    const readyMs = await speak("Ready", 1.0);
    if (!running) return;

    let pauseMs = Math.max(0, Math.round(target - readyMs - lastGoMs[mode]));
    if (pauseMs > 3000) pauseMs = 3000;

    setStatus("...go");
    await new Promise(r => timers.push(setTimeout(r, pauseMs)));
    if (!running) return;

    const goMs = await speak("go!", 1.0);
    lastGoMs[mode] = Math.round(goMs);
  }

  async function speakOnce() {
    await ensureVoicesLoaded();
    if (!running) return;

    if (modeEl.value === "fast") return speakFast();
    if (modeEl.value === "mid") return speakTimed("mid");
    return speakTimed("slow");
  }

  async function runLoop(mySession) {
    if (!running || mySession !== session) return;

    await speakOnce();

    if (!running || mySession !== session) return;

    if (!repeatEl.checked) {
      stop();
      return;
    }

    const gap = getRepeatGapMs();
    setStatus(`väntar (${Math.round(gap/1000)}s)`);
    timers.push(setTimeout(() => runLoop(mySession), gap));
  }

  function lockControls(lock) {
    document.querySelectorAll('input[name="startWindow"]').forEach(x => x.disabled = lock);
    modeEl.disabled = lock;
    repeatEl.disabled = lock;
  }

  async function start() {
    running = true;
    session++;
    const mySession = session;

    btn.textContent = "STOPP";
    btn.classList.replace("start", "stop");
    lockControls(true);

    setStatus("laddar röst…");
    await ensureVoicesLoaded();

    const delay = getStartWindowMs();
    setStatus(`start om ${Math.round(delay/1000)}s`);

    clearTimers();
    timers.push(setTimeout(() => {
      if (!running || mySession !== session) return;
      runLoop(mySession);
    }, delay));
  }

  function stop() {
    running = false;
    clearTimers();
    speechSynthesis.cancel();

    btn.textContent = "START";
    btn.classList.replace("stop", "start");
    lockControls(false);

    setStatus("redo");
  }

  btn.addEventListener("click", () => running ? stop() : start());
  document.addEventListener("visibilitychange", () => document.hidden && running && stop());

  refreshVoices();
})();
</script>
</body>
</html>
