<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ready Go</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 520px; margin: 0 auto; }
    h1 { margin: 0 0 12px 0; font-size: 22px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 12px 0; }
    label { display: inline-flex; align-items: center; gap: 8px; }
    select, button { font-size: 16px; padding: 10px 12px; }
    button { width: 100%; height: 52px; border: 0; border-radius: 12px; cursor: pointer; }
    button.start { background: #111; color: #fff; }
    button.stop { background: #b00020; color: #fff; }
    .status { margin-top: 10px; font-weight: 600; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color:#333; }
    .muted { color:#444; font-size: 13px; line-height: 1.4; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Ready Go</h1>

    <div class="row">
      <div style="flex:1;">
        <div style="font-weight:600; margin-bottom:6px;">Röstläge</div>
        <select id="mode">
          <option value="fast" selected>Snabb (readygo)</option>
          <option value="mid">Mellan (1,5 s)</option>
          <option value="slow">Långsam (2,4 s)</option>
        </select>
        <div class="muted" style="margin-top:6px;">
          Bocka i Shuffle för att slumpa snabb/mellan/långsam varje gång den pratar.
        </div>
      </div>
    </div>

    <div class="row">
      <label><input type="checkbox" id="shuffle"> Shuffle (slumpa röstläge + tid)</label>
    </div>

    <div class="row">
      <div>
        <div style="font-weight:600; margin-bottom:6px;">Startfördröjning (slump)</div>
        <label><input type="radio" name="startWindow" value="2-4" checked> 2–4 sek</label>
        <label style="margin-left:12px;"><input type="radio" name="startWindow" value="3-6"> 3–6 sek</label>
      </div>
    </div>

    <div class="row">
      <label><input type="checkbox" id="shuffleStart"> Shuffle startfönster (2–4 eller 3–6)</label>
    </div>

    <div class="row">
      <label><input type="checkbox" id="repeat"> Repetera (slump 3–6 sek mellan)</label>
    </div>

    <div class="status" id="status">
      Status: redo <span class="pill" id="voiceInfo">röst laddas…</span>
    </div>

    <div class="row" style="margin-top:14px;">
      <button id="startStop" class="start">START</button>
    </div>
  </div>

<script>
(() => {
  const statusEl = document.getElementById('status');
  const voiceInfoEl = document.getElementById('voiceInfo');
  const btn = document.getElementById('startStop');

  const modeEl = document.getElementById('mode');
  const shuffleEl = document.getElementById('shuffle');

  const repeatEl = document.getElementById('repeat');

  const shuffleStartEl = document.getElementById('shuffleStart');

  let running = false;
  let timers = [];
  let session = 0;

  // --- Tunables ---
  const FAST_RATE = 2.2;   // snabbaste: "readygo" sammanslaget
  const PAUSE_MID  = 700;  // Ready -> (700ms) -> go  ~ 1.5s total
  const PAUSE_SLOW = 1100; // Ready -> (1100ms) -> go ~ 2.4s total

  function clearTimers() {
    timers.forEach(t => clearTimeout(t));
    timers = [];
  }

  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function setStatus(text) {
    statusEl.firstChild.textContent = "Status: " + text + " ";
  }

  // --- Start window selection ---
  function pickStartWindow() {
    // returns "2-4" or "3-6"
    if (shuffleStartEl.checked) {
      return randInt(0, 1) === 0 ? "2-4" : "3-6";
    }
    return document.querySelector('input[name="startWindow"]:checked').value;
  }

  function getStartWindowMs() {
    const v = pickStartWindow();
    return v === '2-4' ? randInt(2000, 4000) : randInt(3000, 6000);
  }

  function getRepeatGapMs() {
    return randInt(3000, 6000);
  }

  // --- Mode selection ---
  function pickMode() {
    if (!shuffleEl.checked) return modeEl.value; // fast/mid/slow
    const modes = ["fast", "mid", "slow"];
    return modes[randInt(0, modes.length - 1)];
  }

  // --- Voices / TTS ---
  function getVoicesSafe() {
    try { return speechSynthesis.getVoices() || []; }
    catch { return []; }
  }

  function pickVoicePreferFemaleEn() {
    const voices = getVoicesSafe();
    if (!voices.length) return null;
    const femaleHints = ["female","woman","jenny","susan","emma","zira","samantha"];
    const en = voices.filter(v => (v.lang || "").toLowerCase().startsWith("en"));
    const hinted = en.find(v => femaleHints.some(h => (v.name || "").toLowerCase().includes(h)));
    return hinted || en[0] || voices[0];
  }

  let chosenVoice = null;

  function refreshVoices() {
    chosenVoice = pickVoicePreferFemaleEn();
    const voices = getVoicesSafe();
    voiceInfoEl.textContent = chosenVoice
      ? `${chosenVoice.lang} • ${chosenVoice.name}`
      : (voices.length ? "röst ej vald" : "röst laddas…");
  }

  async function ensureVoicesLoaded(maxWaitMs = 2500) {
    const start = performance.now();
    refreshVoices();
    while (performance.now() - start < maxWaitMs) {
      if (getVoicesSafe().length) return true;
      await new Promise(r => setTimeout(r, 150));
      refreshVoices();
    }
    return false;
  }

  speechSynthesis.onvoiceschanged = refreshVoices;
  setTimeout(refreshVoices, 300);

  function speak(text, rate) {
    return new Promise(resolve => {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = rate;
      if (chosenVoice) u.voice = chosenVoice;
      u.onend = resolve;
      u.onerror = resolve;
      speechSynthesis.speak(u);
    });
  }

  // --- Core speaking ---
  async function speakOnce() {
    await ensureVoicesLoaded();
    if (!running) return;

    speechSynthesis.cancel();

    const mode = pickMode();

    if (mode === "fast") {
      setStatus("readygo!");
      await speak("readygo", FAST_RATE);
      return;
    }

    const pauseMs = mode === "mid" ? PAUSE_MID : PAUSE_SLOW;

    setStatus("Ready...");
    await speak("Ready", 1.0);
    if (!running) return;

    setStatus("...go");
    await new Promise(r => timers.push(setTimeout(r, pauseMs)));
    if (!running) return;

    await speak("go!", 1.0);
  }

  async function runLoop(mySession) {
    if (!running || mySession !== session) return;

    await speakOnce();
    if (!running || mySession !== session) return;

    if (!repeatEl.checked) {
      stop();
      return;
    }

    const gap = getRepeatGapMs();
    setStatus(`väntar (${Math.round(gap/1000)}s)`);
    timers.push(setTimeout(() => runLoop(mySession), gap));
  }

  function lockControls(lock) {
    document.querySelectorAll('input[name="startWindow"]').forEach(x => x.disabled = lock);
    modeEl.disabled = lock;
    shuffleEl.disabled = lock;
    shuffleStartEl.disabled = lock;
    repeatEl.disabled = lock;
  }

  async function start() {
    running = true;
    session++;
    const mySession = session;

    btn.textContent = "STOPP";
    btn.classList.replace("start", "stop");
    lockControls(true);

    setStatus("laddar röst…");
    await ensureVoicesLoaded();

    const delay = getStartWindowMs();
    setStatus(`start om ${Math.round(delay/1000)}s`);

    clearTimers();
    timers.push(setTimeout(() => {
      if (!running || mySession !== session) return;
      runLoop(mySession);
    }, delay));
  }

  function stop() {
    running = false;
    clearTimers();
    speechSynthesis.cancel();

    btn.textContent = "START";
    btn.classList.replace("stop", "start");
    lockControls(false);

    setStatus("redo");
  }

  btn.addEventListener("click", () => running ? stop() : start());
  document.addEventListener("visibilitychange", () => document.hidden && running && stop());

  refreshVoices();
})();
</script>
</body>
</html>
